# 在Xcode中使用自己编译的Clang及插件

### Xcode llvm clang
llvm是一款著名的编译器，由[克里斯·拉特纳](https://zh.wikipedia.org/wiki/%E5%85%8B%E9%87%8C%E6%96%AF%C2%B7%E6%8B%89%E7%89%B9%E7%B4%8D)与维克拉姆·艾夫发起，并因此荣获ACM软件系统奖。
llvm 最早是针对从中间语言到机器语言编译过程（即后端过程）的组件集合，从高级语言到中间语言(即前端过程)仍由GCC完成。接着克里斯发起Clang项目，希望完全取代GCC。Xcode 3.1集成了llvm-GCC编译器，Xcode 3.2实现了Clang 1.0。
### 版本映射
从苹果发布的[Xcode版本记录](https://opensource.apple.com/)可以发现Xcode2.5仍完全使用gcc编译器。[Xcode8.2.1](https://opensource.apple.com/release/developer-tools-821.html)使用 	clang-800.0.42.1，从[配置文件](https://opensource.apple.com/source/clang/clang-800.0.42.1/src/configure.auto.html)中可以看出该版本就是llvm-clang的3.9.0版本。

    #! /bin/sh
    # Guess values for system-dependent variables and create Makefiles.
    # Generated by GNU Autoconf 2.60 for LLVM 3.9.0svn.‘
    
更多映射关系可参照[这里](https://gist.github.com/yamaya/2924292)。

### 编译llvm-clang
选择一个路径，比如 /opt/llvm，用来最为llvm的根节点。  
查看Xcode版本对应的llvm分支，最新的Xcode9.2对应release_50分支。  
执行以下命令获取源码并生成llvm的Xcode项目。cmake的后两个选项是为了能够给iPhone交叉编译，具体可参考[文档](https://llvm.org/docs/HowToCrossCompileLLVM.html)。  

	cd /opt
	sudo mkdir llvm
	sudo chown `whoami` llvm
	cd llvm
	export LLVM_HOME=`pwd`

	git clone -b release_50 git@github.com:llvm-mirror/llvm.git llvm
	git clone -b release_50 git@github.com:llvm-mirror/clang.git llvm/tools/clang
	git clone -b release_50 git@github.com:llvm-mirror/clang-tools-extra.git llvm/tools/clang/tools/extra
	git clone -b release_50 git@github.com:llvm-mirror/compiler-rt.git llvm/projects/compiler-rt

	mkdir llvm_build
	cd llvm_build
	cmake -G Xcode ../llvm -DCMAKE_BUILD_TYPE:STRING=Release -DLLVM_TARGETS_TO_BUILD="ARM;X86;AArch64" -DLLVM_ENABLE_PIC=False



打开llvm_build下的LLVM.xcodeproj项目。
选择clang libclang两个target进行编译。  
经过漫长编译，在 llvm/llvm\_build/Debug/bin下生成了clang，llvm/llvm\_build/Debug/bin下生成了libclang.dylib。

### 在Xcode中使用自己编译的clang

Xcode原则上不支持Clang插件，为了在Xcode build settings中添加选择编译器的选项，下载并解压[这个](https://github.com/AlexDenisov/ToyClangPlugin/releases/download/0.0.1/XcodeHacking.zip)

执行如下命令  
	
	(这个操作可能没什么用)sudo mv HackedClang.xcplugin `xcode-select -print-path`/../PlugIns/Xcode3Core.ideplugin/Contents/SharedSupport/Developer/Library/Xcode/Plug-ins
	sudo mv HackedBuildSystem.xcspec `xcode-select -print-path`/Platforms/iPhoneSimulator.platform/Developer/Library/Xcode/Specifications
	
如有必要，修改clang路径
	
	/Applications/Xcode.app/Contents/PlugIns/Xcode3Core.ideplugin/Contents/SharedSupport/Developer/Library/Xcode/Plug-ins/HackedClang.xcplugin/Contents/Resources/HackedClang.xcspec
	文件中的
	ExecPath = "XXX/llvm/llvm_build/Debug/bin/clang";
	
打开目标项目，选中build settings，选择  

	Complier for C/C++/Objective-C : Clang LLVM Trunk

在项目中添加clang 与libclang两个schema，进行漫长的编译。

链接过程中，如果因为bitcode发生链接错误，尝试关闭bitcode选项修复
	
	Enable Bitcode : false